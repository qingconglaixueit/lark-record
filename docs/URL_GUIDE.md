# 飞书多维表格URL使用指南

本文档详细说明如何获取和使用飞书多维表格的URL。

## 支持的URL格式

本扩展支持两种飞书多维表格URL格式：

### 1. 直接多维表格链接 (📄)

适用于在个人空间或群组中直接创建的多维表格。

**URL格式：**
```
https://xxx.feishu.cn/base/bascnxxxxxxxxxxxxxxx
```

**关键特征：**
- URL路径中包含 `/base/`
- `bascn` 开头的token就是多维表格的app_token

**获取方法：**
1. 在飞书中打开多维表格
2. 复制浏览器地址栏中的完整URL
3. 粘贴到配置页面

**示例：**
```
https://example.feishu.cn/base/bascnABCDEFGHIJKLMNOPQ
```

---

### 2. 知识库中的多维表格链接 (📖)

适用于在飞书知识库中创建或嵌入的多维表格。

**URL格式：**
```
https://xxx.feishu.cn/wiki/BEsNwa5DginWlykCmSMcIOf9n9b?table=tblVUtuHVBWAJdl3&view=vew1wOKAOt
```

**关键特征：**
- URL路径中包含 `/wiki/`
- wiki页面的token（如 `BEsNwa5DginWlykCmSMcIOf9n9b`）作为app_token
- 可能包含查询参数（`?table=xxx&view=xxx`）

**获取方法：**
1. 在飞书知识库中打开包含多维表格的页面
2. 确保已选中某个数据表（会在URL中显示table参数）
3. 复制浏览器地址栏中的**完整URL**（包括所有参数）
4. 粘贴到配置页面

**示例：**
```
https://example.feishu.cn/wiki/BEsNwa5DginWlykCmSMcIOf9n9b?table=tblVUtuHVBWAJdl3
```

**⚠️ 重要提示：**
- 对于知识库中的表格，URL中的wiki token就是多维表格的app_token
- 某些情况下可能需要将飞书应用添加为知识库的协作者才能访问

---

## 常见问题

### Q: 为什么验证失败，提示"该Token不存在或无权访问"？

**A:** 可能的原因：
1. **权限问题**：飞书应用没有访问该表格的权限
   - 解决方法：将飞书应用添加为表格或知识库的协作者
2. **URL不完整**：复制的URL不完整
   - 解决方法：确保复制了完整的URL，包括所有参数
3. **表格已删除**：该表格可能已被删除或移动
   - 解决方法：检查表格是否仍然存在

### Q: 知识库链接和直接表格链接有什么区别？

**A:** 
- **直接表格链接**：表格独立存在，app_token直接对应该表格
- **知识库链接**：表格嵌入在知识库页面中，wiki页面token作为app_token

两种链接都可以正常使用，系统会自动识别并处理。

### Q: 如何将飞书应用添加为协作者？

**A:** 
1. 打开飞书多维表格或知识库
2. 点击右上角的"分享"或"协作"按钮
3. 搜索并添加你的飞书应用（使用App ID搜索）
4. 授予适当的权限（建议授予编辑权限）

### Q: URL中的参数（table、view）重要吗？

**A:** 
- `table` 参数：非常重要，指定了要访问的数据表ID
- `view` 参数：可选，指定了视图，通常不影响数据访问

建议复制完整URL，确保包含所有必要参数。

---

## 最佳实践

1. **始终复制完整URL**：包括所有查询参数
2. **验证后再保存**：在配置页面验证URL后再保存配置
3. **权限管理**：确保飞书应用有适当的访问权限
4. **定期检查**：如果表格移动或权限变更，需要重新配置

---

## 技术说明

### URL解析逻辑

系统会按以下逻辑解析URL：

1. **检测URL类型**：
   - 包含 `/base/` → 直接多维表格
   - 包含 `/wiki/` → 知识库表格

2. **提取app_token**：
   - 直接表格：从 `/base/` 后提取token
   - 知识库表格：从 `/wiki/` 后提取token

3. **调用飞书API**：
   - 使用提取的app_token访问多维表格API
   - 获取数据表列表和字段信息

### 错误代码说明

- **91402 (NOTEXIST)**：Token不存在或无权访问
  - 检查URL是否正确
  - 检查应用权限
  - 将应用添加为协作者

- **99991663 (Permission Denied)**：权限不足
  - 需要将应用添加为表格的协作者
  - 检查应用是否有必要的权限范围

---

## 支持

如有问题，请：
1. 检查本文档的常见问题部分
2. 查看浏览器控制台的错误信息
3. 提交Issue到项目仓库
